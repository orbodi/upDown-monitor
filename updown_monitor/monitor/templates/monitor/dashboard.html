<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>UpDown Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body { background-color: #F4F4F4; }
    .atos-blue { background-color: #4C8CBF; color: white; }
    .atos-green { background-color: #78BE20; color: white; }
    .atos-red { background-color: #E94E1B; color: white; }
    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#0066A1;">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">UpDown Monitor</a>
  </div>
</nav>

<div id="loader">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="container mt-4" id="dashboard">

  <!-- CARDS -->
  <div class="row text-center mb-4">
    <div class="col-md-4 mb-2">
      <div class="card atos-blue shadow-sm">
        <div class="card-body">
          <h5>Total</h5>
          <h2 id="total-count">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="card atos-green shadow-sm">
        <div class="card-body">
          <h5>UP</h5>
          <h2 id="up-count">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-2">
      <div class="card atos-red shadow-sm">
        <div class="card-body">
          <h5>DOWN</h5>
          <h2 id="down-count">0</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLEAU -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3>Liste des Devices</h3>
    <button class="btn btn-outline-primary btn-sm" onclick="exportCSV()">Exporter CSV</button>
  </div>
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-striped" id="devices-table">
      <thead class="table-light">
        <tr>
          <th>Nom</th>
          <th>IP</th>
          <th>Status</th>
          <th>Dernier check</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="container">
  <div class="row justify-content-center g-3">
    <!-- Card Disponibilité -->
    <div class="col-12 col-md-5 d-flex">
      <div class="card shadow-sm flex-fill d-flex flex-column">
        <div class="card-header text-center bg-success text-white">
          Disponibilité (UP vs DOWN)
        </div>
        <div class="card-body d-flex justify-content-center align-items-center flex-fill">
          <canvas id="statusChart" class="w-100" style="max-height:350px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Card Trend / Répartition -->
    <div class="col-12 col-md-5 d-flex">
      <div class="card shadow-sm flex-fill d-flex flex-column">
        <div class="card-header text-center bg-primary text-white">
          Trend / Répartition
        </div>
        <div class="card-body d-flex justify-content-center align-items-center flex-fill">
          <canvas id="trendChart" class="w-100" style="max-height:350px;"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let statusChart, trendChart;
let devicesCache = [];

function showLoader(show = true) {
  document.getElementById('loader').style.display = show ? 'block' : 'none';
}

// CSRF token pour POST
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const CSRF_TOKEN = getCookie('csrftoken');

// Récupère les devices
async function fetchDevices() {
  showLoader(true);
  try {
    const resp = await fetch('/api/devices/');
    devicesCache = await resp.json();

    const tbody = document.querySelector('#devices-table tbody');
    tbody.innerHTML = '';

    let upCount = 0, downCount = 0;

    devicesCache.forEach(device => {
      if (device.status === 'UP') upCount++; else downCount++;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${device.name}</td>
        <td>${device.ip_address}</td>
        <td>${device.status === 'UP' ? '<span class="badge bg-success">UP</span>' : '<span class="badge bg-danger">DOWN</span>'}</td>
        <td>${device.last_check || '-'}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('total-count').textContent = devicesCache.length;
    document.getElementById('up-count').textContent = upCount;
    document.getElementById('down-count').textContent = downCount;

    updateCharts(upCount, downCount);
  } catch (err) {
    console.error(err);
  } finally {
    showLoader(false);
  }
}

// Mets à jour les devices toutes les 60s
setInterval(async () => {
  showLoader(true);
  await fetch('/api/devices/update/', { method: 'POST', headers: { 'X-CSRFToken': CSRF_TOKEN } });
  fetchDevices();
}, 60000);

// Premier fetch
fetchDevices();

// Update charts
function updateCharts(up, down) {
  const ctxStatus = document.getElementById('statusChart').getContext('2d');
  if (statusChart) statusChart.destroy();
  statusChart = new Chart(ctxStatus, {
    type: 'doughnut',
    data: { labels: ['UP','DOWN'], datasets:[{ data:[up,down], backgroundColor:['#78BE20','#E94E1B'] }] },
    options: { plugins: { datalabels: { formatter: (v, ctx) => (v*100/(up+down)).toFixed(1)+'%', color:'#fff' } } },
    plugins: [ChartDataLabels]
  });

  const ctxTrend = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(ctxTrend, {
    type:'bar',
    data:{ labels:['UP','DOWN'], datasets:[{ label:'Devices', data:[up,down], backgroundColor:['#78BE20','#E94E1B'] }] },
    options:{ plugins:{ datalabels:{ anchor:'end', align:'end', color:'#333', formatter: v => v } }, scales:{ y:{ beginAtZero:true } } },
    plugins: [ChartDataLabels]
  });
}

// Export CSV
function exportCSV() {
  let rows = [['Nom','IP','Status','Dernier check']];
  devicesCache.forEach(d=>rows.push([d.name,d.ip_address,d.status,d.last_check||'']));
  let csv = rows.map(r=>r.join(',')).join('\n');
  let blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'devices.csv';
  link.click();
}
</script>
</body>
</html>
